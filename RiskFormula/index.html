<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>위험률산출</title>
    <script	src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
		body{
			padding: 0px;
			margin: 0px;
		}

        .node {
            cursor: pointer;
        }
        .node circle {
            fill: steelblue;
            stroke: steelblue;
            stroke-width: 2px;
        }
        
        .node text { 
            font-size:12px; 
            font-family:sans-serif;
            text-shadow:
		        -1px -1px 3px white,
		        -1px  1px 3px white,
		         1px -1px 3px white,
		         1px  1px 3px white; }
        
        .node--internal text {
            text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
        }
        
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }

        .noneStrk { 
            fill: none;
        }

		div.tooltip {	
            position: absolute;			
            text-align: left;		
            padding: 5px;				
            font-size: 4px;		
            background: lightsteelblue;	
            border: 0px;		
            border-radius: 8px;			
            pointer-events: none;			
        }
    </style>
    
</head>
<body>
    <div id="chart"></div>
    <script src="http://d3js.org/d3.v5.min.js"></script>
    <script>
        var treeData = 
        {
	"riskName": "2021",
	"children": [
		{
			"exeChk": "",
			"status": "",
			"delChk": "",
			"riskID": "1",
			"riskName": "위험률 a",
			"formula": "b*3",
			"riskVal": "b=3",
			"rsltVal": "9",
			"parentID": "",
			"children": [
				{
					"exeChk": "",
					"status": "",
					"delChk": "",
					"riskID": "2",
					"riskName": "위험률 a-1",
					"formula": "b*2",
					"riskVal": "b=1+{1}",
					"rsltVal": "20",
					"parentID": "1",
					"children": [
						{
							"exeChk": "",
							"status": "",
							"delChk": "",
							"riskID": "3",
							"riskName": "위험률 a-2",
							"formula": "c-3",
							"riskVal": "c={2}-{1}",
							"rsltVal": "8",
							"parentID": "2",
							"children": [
								{
									"exeChk": "",
									"status": "",
									"delChk": "",
									"riskID": "4",
									"riskName": "위험률 a-3",
									"formula": "d+5",
									"riskVal": "d={3}",
									"rsltVal": "13",
									"parentID": "3",
									"children": [
										{
											"exeChk": "",
											"status": "",
											"delChk": "",
											"riskID": "7",
											"riskName": "위험률 a-4",
											"formula": "a-3",
											"riskVal": "a={4}",
											"rsltVal": "10",
											"parentID": "4",
											"children": [],
											"level": "5",
											"remarks": "",
											"aply_yr": "2021",
											"dataList": null
										}
									],
									"level": "4",
									"remarks": "",
									"aply_yr": "2021",
									"dataList": null
								},
								{
									"exeChk": "",
									"status": "",
									"delChk": "",
									"riskID": "5",
									"riskName": "위험률 a-31",
									"formula": "e+5",
									"riskVal": "e={2}",
									"rsltVal": "25",
									"parentID": "3",
									"children": [],
									"level": "4",
									"remarks": "",
									"aply_yr": "2021",
									"dataList": null
								}
							],
							"level": "3",
							"remarks": "",
							"aply_yr": "2021",
							"dataList": null
						}
					],
					"level": "2",
					"remarks": "",
					"aply_yr": "2021",
					"dataList": null
				}
			],
			"level": "1",
			"remarks": "",
			"aply_yr": "2021",
			"dataList": null
		},
		{
			"exeChk": "",
			"status": "",
			"delChk": "",
			"riskID": "11",
			"riskName": "위험률 b",
			"formula": "b*3",
			"riskVal": "b=2",
			"rsltVal": "6",
			"parentID": "",
			"children": [
				{
					"exeChk": "",
					"status": "",
					"delChk": "",
					"riskID": "12",
					"riskName": "위험률 b-1",
					"formula": "f+5",
					"riskVal": "f={11}*4",
					"rsltVal": "29",
					"parentID": "11",
					"children": [
						{
							"exeChk": "",
							"status": "",
							"delChk": "",
							"riskID": "13",
							"riskName": "위험률 b-2",
							"formula": "g-5",
							"riskVal": "g={11}+{12}",
							"rsltVal": "30",
							"parentID": "12",
							"children": [
								{
									"exeChk": "",
									"status": "",
									"delChk": "",
									"riskID": "14",
									"riskName": "위험률 b-3",
									"formula": "h/5",
									"riskVal": "h={12}-{11}",
									"rsltVal": "4.6",
									"parentID": "13",
									"children": [],
									"level": "4",
									"remarks": "",
									"aply_yr": "2021",
									"dataList": null
								}
							],
							"level": "3",
							"remarks": "",
							"aply_yr": "2021",
							"dataList": null
						}
					],
					"level": "2",
					"remarks": "",
					"aply_yr": "2021",
					"dataList": null
				}
			],
			"level": "1",
			"remarks": "",
			"aply_yr": "2021",
			"dataList": null
		},
		{
			"exeChk": "",
			"status": "",
			"delChk": "",
			"riskID": "21",
			"riskName": "위험률 c",
			"formula": "i+1",
			"riskVal": "i=5",
			"rsltVal": "6",
			"parentID": "",
			"children": [
				{
					"exeChk": "",
					"status": "",
					"delChk": "",
					"riskID": "22",
					"riskName": "위험률 c-1",
					"formula": "j*2",
					"riskVal": "j={21}",
					"rsltVal": "12",
					"parentID": "21",
					"children": [
						{
							"exeChk": "",
							"status": "",
							"delChk": "",
							"riskID": "23",
							"riskName": "위험률 c-2",
							"formula": "a+1",
							"riskVal": "a={22}",
							"rsltVal": "13",
							"parentID": "22",
							"children": [
								{
									"exeChk": "",
									"status": "",
									"delChk": "",
									"riskID": "45",
									"riskName": "위험률 c-3",
									"formula": "none",
									"riskVal": "none",
									"rsltVal": "",
									"parentID": "23",
									"children": [],
									"level": "4",
									"remarks": "",
									"aply_yr": "",
									"dataList": null
								}
							],
							"level": "3",
							"remarks": "",
							"aply_yr": "2021",
							"dataList": null
						}
					],
					"level": "2",
					"remarks": "",
					"aply_yr": "2021",
					"dataList": null
				}
			],
			"level": "1",
			"remarks": "",
			"aply_yr": "2021",
			"dataList": null
		}
	]
}
        
        var margin = {top:20, right:90, bottom:30, left:70},
            width = $('#chart').width() - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

		var div = d3.select("body").append("div")
			.attr("class", "tooltip")
			.style("opacity", 0);

        var treemap = d3.tree()
            .size([height, width]);

        var nodes = d3.hierarchy(treeData, function(d){
            return d.children;
        });

        nodes = treemap(nodes);
        
        var svg = d3.select("#chart").append("svg")
            .attr("width", width + margin.left + margin.right - 10)
            .attr("height", height + margin.top + margin.bottom);
        
        var g = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var link = g.selectAll(".link")
            .data(nodes.descendants().slice(1))
            .enter().append("path")
            .attr("class", function(d){
				return d.data.parentID == "" ? "noneStrk" : "link";
			})
            .attr("d", function(d){
                return "M" + d.y + "," + d.x
                    + "C" + (d.y + d.parent.y) / 2 + "," + d.x 
                    + " " + (d.y + d.parent.y) / 2 + "," + d.parent.x
                    + " " + d.parent.y + "," +d.parent.x;
            });
        var mouseOverFunction = function(d){
			var circle = d3.select(this);
			var path = g.selectAll("path.link");


		}
		var linkedByIndex = {};
		function isConnected(a, b) {
    		return isConnectedAsTarget(a, b) || isConnectedAsSource(a, b) || a.index === b.index;
		}

		function isConnectedAsSource(a, b) {
			return linkedByIndex[`${a.index},${b.index}`];
		}

		function isConnectedAsTarget(a, b) {
			return linkedByIndex[`${b.index},${a.index}`];
		}
		
		function isEqual(a, b) {
			return a.index === b.index;
		}

		var mouseOverFunction = function(d){
			var circle = d3.select(this).select("circle");
				var path = g.selectAll("path.link");

				node.transition(500)
					.style("opacity", function(o){
						var isConnectedValue = isConnected(o, d);
						if(isConnectedValue){
							return 1.0;
						}
						return 0.2;
					});
				
				path.transition(500)
					.style("stroke", function(o){
						var flag = false;

						if(o.target === d) flag = true;
						else {
							for(var i=0; i<10; i++) {
								var obj = 'd'+'.parent'.repeat(i);
								if(eval(obj).hasOwnProperty('parent')) {
									if(o.target === eval(obj+'.parent')) flag = true;
								} else {
									break;
								}
							}
						}
						return (flag ? "orange" : "#ccc");
					})
				
				circle.transition(500)
					.style("fill", "orange")
					.style("stroke", "orange");
				
				div.transition()
					.duration(200)
					.style("opacity", .9);
				div.html( "계산식 : " + d.data.formula + "<br>"
					+"변수값 : " + d.data.riskVal + "<br>"
					+"계산결과 : " + d.data.rsltVal)
					.style("left", (d3.event.pageX) + "px")
					.style("top", (d3.event.pageY) + "px")
					.attr("transform", "translate(" + d.y + "," + d.x  + ")")
					.attr("dy", ".35em");		
		}

		var mouseOutFunction = function(d){
			var circle = d3.select(this).select("circle");
			var path = g.selectAll("path.link");

			node.transition(500);

			path.transition(500)
				.style("stroke", "#ccc");

			circle.transition(500)
				.style("fill", "steelblue")
				.style("stroke", "steelblue");

			div.transition()
				.duration(500)
				.style("opacity", 0);
		}
        var node = g.selectAll(".node")
            .data(nodes.descendants())
            .enter().append("g")
            .attr("class", function(d){
                return "node" + (d.children ? " node--internal" : " node--leaf");
            })
            .attr("transform", function(d){
                return "translate(" + d.y + "," + d.x + ")";
            })
			.on("mouseover", function(d){	
						
			})
			.on("mouseout", function(d){
				
			});
        
        node.append("circle")
            .attr("class", function(d){
                return (d.parent == undefined ) ? "" : "nodeCircle";
            })
            .attr("r", 0)
            .attr("fill", function(d){
                return d.children ? "lightsteelblue" : "#325d79";
            });


        node.append("text")
            .attr("dy", function(d){
                return (d.parent == undefined ) ? "3" : "-13";
            })
            .style("text-anchor", function(d){
                return "middle";
            })
            .text(function(d){ return d.data.riskName; });
        
        node.select("circle.nodeCircle")
            .attr("r", 6);

		
    </script>
</body>
</html>